name: Test

on: [push]

jobs:
  test:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.11"]
        
    steps:
      # setup python
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      
      # verify python version
      - name: Display Python version
        run: python -c "import sys; print(sys.version)"

      # https://stackoverflow.com/questions/62977821/how-to-cache-poetry-install-for-github-actions
      # cache poetry venv
      - name: Load cached venv
        id: cached-poetry-venv
        uses: actions/cache@v2
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install poetry
        run: python -m pip install poetry==1.7.1
        if: steps.cached-poetry-venv.outputs.cache-hit != 'true'

      - name: Configure poetry
        run: poetry config virtualenvs.in-project true

      # create venv and install dependencies
      - name: Install dependencies
        run: poetry install --with test

      - name: Setup postgres
        run: |
          $downloadUrl = "https://get.enterprisedb.com/postgresql/postgresql-16.1-1-windows-x64.exe"
          $installerPath = "$env:TEMP\postgres.exe"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $installerPath
          $postgresPath = "$env:ProgramFiles\PostgreSQL\16"
          Start-Process -FilePath $installerPath -ArgumentList "/superpassword","123","/serverport","8000","/prefix","$postgresPath","/enable-components","server,commandlinetools","/quiet","/passive" -Wait
          Remove-Item $installerPath -Force
          # display install dir
          Write-Host "Program Files"
          dir "$env:ProgramFiles"
          Write-Host "PostgreSQL"
          dir "$postgresPath"
          dir "$postgresPath\bin"
          # start server
          & "$postgresPath\bin\pg_ctl.exe" start -D "$postgresPath\data"
          Write-Host "$postgresPath\bin\pg_ctl.exe" status -D "$postgresPath\data"

      - name: Install postgres ODBC driver
        run: |
          $downloadUrl = "https://ftp.postgresql.org/pub/odbc/versions/msi/psqlodbc_16_00_0000-x64.zip"
          $downloadPath = "$env:TEMP\psqlodbc.zip"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $downloadPath
          # extract psqlodbc installer
          $extractPath = "$env:TEMP\psqlodbc"
          Expand-Archive -Path $downloadPath -DestinationPath $extractPath -Force
          # run psqlodbc installer
          $installerPath = "$env:TEMP\psqlodbc\psqlodbc_x64.msi"
          Start-Process -FilePath $installerPath -ArgumentList "/quiet","/passive" -Wait
          # remove downloads
          if (Test-Path $extractPath) { Remove-Item $extractPath -Force -Recurse } else { Write-Host "Item $extractPath does not exist" }
          if (Test-Path $downloadPath) { Remove-Item $downloadPath -Force } else { Write-Host "Item $downloadPath does not exist" }

      - name: Install Access Database Engine
        run: |
          $downloadUrl = "https://download.microsoft.com/download/2/4/3/24375141-E08D-4803-AB0E-10F2E3A07AAA/AccessDatabaseEngine_X64.exe"
          $installerPath = "$env:TEMP\accessdatabaseengine.exe"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $installerPath
          Start-Process -FilePath $installerPath -ArgumentList "/quiet","/passive" -Wait
          Remove-Item $installerPath -Force

      - name: Display ODBC drivers
        run: Get-OdbcDriver
      
      - name: Display ODBC DSNs
        run: Get-OdbcDsn

      - name: Run tests
        run: poetry run pytest
